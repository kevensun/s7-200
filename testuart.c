#include <sys/ioctl.h>
#include <string.h>
#include "uart.h"
#include <termios.h>
#include <unistd.h>
#include <stdlib.h>

enum{
	U_MODE_FULL_422 = 0,
	U_MODE_HALF_485 = 1,
	U_MODE_FULL_232 = 2,
};
#define TIOCSERMODE	0x5460

#define WAITTIME 100000

char *dectobin(int dec)
{
	char *ret;
	int x=0,i=0;
	ret=(char *)malloc(sizeof(char *)*8);
	if(NULL==ret)
	{
		exit(1);
	}
	memset(ret,0,sizeof(char *)*8);
	while(dec!=0)
	{
		x=dec%2;
		ret[i]=x;
		i++;
		dec=dec/2;
	}
	return ret;
}
	char confirm[]=		{0x10,0x02,0x00,0x5C,0x5E,0x16};
	char hello[]  =		{0x10,0x02,0x00,0x49,0x4B,0x16};

	char readq[]  = 	{0x68,0x1B,0x1B,0x68,0x02,0x00,0x6C,0x32,0x01,0x00,
						 0x00,0x00,0x00,0x00,0x0E,0x00,0x00,0x04,0x01,0x12,
						 0x0A,0x10,0x02,0x00,0x02,0x00,0x00,0x82,0x00,0x00,
					 	 0x00,0x66,0x16};
	char readi[]  =		{0x68,0x1B,0x1B,0x68,0x02,0x00,0x6C,0x32,0x01,0x00,
						 0x00,0x00,0x00,0x00,0x0E,0x00,0x00,0x04,0x01,0x12,
						 0x0A,0x10,0x02,0x00,0x03,0x00,0x00,0x81,0x00,0x00,
						 0x00,0x66,0x16};
	char readvd312[]  = {0x68,0x1B,0x1B,0x68,0x02,0x00,0x6C,0x32,0x01,0x00,
					 	 0x00,0x00,0x00,0x00,0x0E,0x00,0x00,0x04,0x01,0x12,
						 0x0A,0x10,0x06,0x00,0x01,0x00,0x01,0x84,0x00,0x09,
						 0xc0,0x35,0x16};
	char readvd300[]  = {0x68,0x1B,0x1B,0x68,0x02,0x00,0x6C,0x32,0x01,0x00,
					 	 0x00,0x00,0x00,0x00,0x0E,0x00,0x00,0x04,0x01,0x12,
						 0x0A,0x10,0x06,0x00,0x01,0x00,0x01,0x84,0x00,0x09,
						 0x60,0xd5,0x16};
	char readvd304[]  = {0x68,0x1B,0x1B,0x68,0x02,0x00,0x6C,0x32,0x01,0x00,
					 	 0x00,0x00,0x00,0x00,0x0E,0x00,0x00,0x04,0x01,0x12,
						 0x0A,0x10,0x06,0x00,0x01,0x00,0x01,0x84,0x00,0x09,
						 0x80,0xf5,0x16};
	char readvd308[]  = {0x68,0x1B,0x1B,0x68,0x02,0x00,0x6C,0x32,0x01,0x00,
					 	 0x00,0x00,0x00,0x00,0x0E,0x00,0x00,0x04,0x01,0x12,
						 0x0A,0x10,0x06,0x00,0x01,0x00,0x01,0x84,0x00,0x09,
						 0xa0,0x15,0x16};
	char readvw172[]  = {0x68,0x1B,0x1B,0x68,0x02,0x00,0x6C,0x32,0x01,0x00,
					 	 0x00,0x00,0x00,0x00,0x0E,0x00,0x00,0x04,0x01,0x12,
						 0x0A,0x10,0x04,0x00,0x01,0x00,0x01,0x84,0x00,0x05,
						 0x60,0xcf,0x16};
	char readvw178[]  = {0x68,0x1B,0x1B,0x68,0x02,0x00,0x6C,0x32,0x01,0x00,
					 	 0x00,0x00,0x00,0x00,0x0E,0x00,0x00,0x04,0x01,0x12,
						 0x0A,0x10,0x04,0x00,0x01,0x00,0x01,0x84,0x00,0x05,
						 0x90,0xff,0x16};
	char readvw184[]  = {0x68,0x1B,0x1B,0x68,0x02,0x00,0x6C,0x32,0x01,0x00,
					 	 0x00,0x00,0x00,0x00,0x0E,0x00,0x00,0x04,0x01,0x12,
						 0x0A,0x10,0x04,0x00,0x01,0x00,0x01,0x84,0x00,0x05,
						 0xc0,0x2f,0x16};
	char readvw190[]  = {0x68,0x1B,0x1B,0x68,0x02,0x00,0x6C,0x32,0x01,0x00,
					 	 0x00,0x00,0x00,0x00,0x0E,0x00,0x00,0x04,0x01,0x12,
						 0x0A,0x10,0x04,0x00,0x01,0x00,0x01,0x84,0x00,0x05,
						 0xf0,0x5f,0x16};
	char readvw196[]  = {0x68,0x1B,0x1B,0x68,0x02,0x00,0x6C,0x32,0x01,0x00,
					 	 0x00,0x00,0x00,0x00,0x0E,0x00,0x00,0x04,0x01,0x12,
						 0x0A,0x10,0x04,0x00,0x01,0x00,0x01,0x84,0x00,0x06,
						 0x20,0x90,0x16};
	char readvw202[]  = {0x68,0x1B,0x1B,0x68,0x02,0x00,0x6C,0x32,0x01,0x00,
					 	 0x00,0x00,0x00,0x00,0x0E,0x00,0x00,0x04,0x01,0x12,
						 0x0A,0x10,0x04,0x00,0x01,0x00,0x01,0x84,0x00,0x06,
						 0x50,0xc0,0x16};
	char readvw208[]  = {0x68,0x1B,0x1B,0x68,0x02,0x00,0x6C,0x32,0x01,0x00,
					 	 0x00,0x00,0x00,0x00,0x0E,0x00,0x00,0x04,0x01,0x12,
						 0x0A,0x10,0x04,0x00,0x01,0x00,0x01,0x84,0x00,0x06,
						 0x80,0xf0,0x16};
	char readvd18[]   = {0x68,0x1B,0x1B,0x68,0x02,0x00,0x6C,0x32,0x01,0x00,
					 	 0x00,0x00,0x00,0x00,0x0E,0x00,0x00,0x04,0x01,0x12,
						 0x0A,0x10,0x06,0x00,0x01,0x00,0x01,0x84,0x00,0x00,
						 0x90,0xfc,0x16};
	char readvd22[]   = {0x68,0x1B,0x1B,0x68,0x02,0x00,0x6C,0x32,0x01,0x00,
					 	 0x00,0x00,0x00,0x00,0x0E,0x00,0x00,0x04,0x01,0x12,
						 0x0A,0x10,0x06,0x00,0x01,0x00,0x01,0x84,0x00,0x00,
						 0xb0,0x1c,0x16};	
	char readvw192[]  = {0x68,0x1B,0x1B,0x68,0x02,0x00,0x6C,0x32,0x01,0x00,
					 	 0x00,0x00,0x00,0x00,0x0E,0x00,0x00,0x04,0x01,0x12,
						 0x0A,0x10,0x04,0x00,0x01,0x00,0x01,0x84,0x00,0x06,
						 0x00,0x70,0x16};
	char readvw198[]  = {0x68,0x1B,0x1B,0x68,0x02,0x00,0x6C,0x32,0x01,0x00,
					 	 0x00,0x00,0x00,0x00,0x0E,0x00,0x00,0x04,0x01,0x12,
						 0x0A,0x10,0x04,0x00,0x01,0x00,0x01,0x84,0x00,0x06,
						 0x30,0xa0,0x16};	
	char readvw204[]  = {0x68,0x1B,0x1B,0x68,0x02,0x00,0x6C,0x32,0x01,0x00,
					 	 0x00,0x00,0x00,0x00,0x0E,0x00,0x00,0x04,0x01,0x12,
						 0x0A,0x10,0x04,0x00,0x01,0x00,0x01,0x84,0x00,0x06,
						 0x60,0xd0,0x16};	
	char readvw210[]  = {0x68,0x1B,0x1B,0x68,0x02,0x00,0x6C,0x32,0x01,0x00,
					 	 0x00,0x00,0x00,0x00,0x0E,0x00,0x00,0x04,0x01,0x12,
						 0x0A,0x10,0x04,0x00,0x01,0x00,0x01,0x84,0x00,0x06,
						 0x90,0x00,0x16};
	char readvd534[]  = {0x68,0x1B,0x1B,0x68,0x02,0x00,0x6C,0x32,0x01,0x00,
					 	 0x00,0x00,0x00,0x00,0x0E,0x00,0x00,0x04,0x01,0x12,
						 0x0A,0x10,0x06,0x00,0x01,0x00,0x01,0x84,0x00,0x10,
						 0xb0,0x2c,0x16};					 					 				 				 					 
	char readvd540[]  = {0x68,0x1B,0x1B,0x68,0x02,0x00,0x6C,0x32,0x01,0x00,
					 	 0x00,0x00,0x00,0x00,0x0E,0x00,0x00,0x04,0x01,0x12,
						 0x0A,0x10,0x06,0x00,0x01,0x00,0x01,0x84,0x00,0x10,
						 0xe0,0x5c,0x16};
	char readvd4550[]  = {0x68,0x1B,0x1B,0x68,0x02,0x00,0x6C,0x32,0x01,0x00,
					 	 0x00,0x00,0x00,0x00,0x0E,0x00,0x00,0x04,0x01,0x12,
						 0x0A,0x10,0x06,0x00,0x01,0x00,0x01,0x84,0x00,0x8e,
						 0x30,0x2a,0x16};
	char readvd4580[]  = {0x68,0x1B,0x1B,0x68,0x02,0x00,0x6C,0x32,0x01,0x00,
					 	 0x00,0x00,0x00,0x00,0x0E,0x00,0x00,0x04,0x01,0x12,
						 0x0A,0x10,0x06,0x00,0x01,0x00,0x01,0x84,0x00,0x8f,
						 0x20,0x1b,0x16};					 					 

int readvd(int fd,char vdx[])
{
	char buf[512];
	int nread=0,x=0;
	int i=0;
	write(fd,vdx,33);
	usleep(WAITTIME);
	nread=read(fd, buf, 512);
	if(nread>0)
	{
		if(buf[0]==0xE5)
		{
			//printf("receive E5\n");
			write(fd,confirm,6);
			usleep(WAITTIME);
		}	
	}
	else
	{
		printf("not receive E5\n");
		return -5;
	}
	nread=read(fd, buf, 512);
	printf("\nlen:%d\n", nread);
	if(nread>0)
	{
		for(i=0;i<nread;i++)
		printf("%02x ",buf[i]);
		printf("\n");
		x=(buf[25]<<24)+(buf[26]<<16)+(buf[27]<<8)+buf[28];
		//printf("result is 0x%x,",x);	
	}
	else
	{
		return -1;
	}
		write(fd,hello,6);
		usleep(WAITTIME);
		nread=read(fd, buf, 512);
		return x;
}

int readvw(int fd,char vdx[])
{
	char buf[512];
	int nread=0,x=0;
	int i=0;
	write(fd,vdx,33);
	usleep(WAITTIME);
	nread=read(fd, buf, 512);
	if(nread>0)
	{
		if(buf[0]==0xE5)
		{
			//printf("receive E5\n");
			write(fd,confirm,6);
			usleep(WAITTIME);
		}	
	}
	else
	{
		printf("not receive E5\n");
		return -5;
	}
	nread=read(fd, buf, 512);
	printf("\nlen:%d\n", nread);
	if(nread>0)
	{
		for(i=0;i<nread;i++)
		printf("%02x ",buf[i]);
		printf("\n");
		x=(buf[25]<<8)+buf[26];
		//printf("result is 0x%x ,",x);	
	}
	else
	{
		return -1;
	}
		write(fd,hello,6);
		usleep(WAITTIME);
		nread=read(fd, buf, 512);
		return x;
}

int main(int argc, char **argv)
{
	int fd = -1;
	int i;
	char ch;
	char *file = "/dev/ttymxc1";   //uart2
	char buff[512];
	int nread;
	struct termios old;
	struct termios termiosnew;

	
	char *q0,*q1,*i0,*i1,*i2;
	int vd312,vd300,vd304,vd308,vw172,vw178,vw184,vw190,vw196,vw202;
	int vw208,vd18,vd22,vw192,vw198,vw204,vw210,vd534,vd4550,vd540,vd4580;
	int x;
	fd = open(file, O_RDWR|O_NOCTTY);
	if(fd<0)
	printf("open error\n");
	//ioctl(fd, TIOCSERMODE, U_MODE_FULL_232);

	get_termios(fd, &old);
	//show_termios(&old);
	uart_config(fd, 9600, 'e', 8, 1);
	get_termios(fd, &termiosnew);
	//show_termios(&new);
	tcflush(fd,TCIFLUSH);
	fcntl(fd,F_SETFL,0);

	while(1)
	{
		printf("-----begin-----\n");
		
		//开始读取输出Q0.0-Q1.7
		write(fd,readq,33);//发送读输出指令
		usleep(WAITTIME);
		nread=read(fd, buff, 512);//接收返回数据
		if(nread>0)
		{
			if(buff[0]==0xE5)
			{
				//printf("receive E5\n");
				write(fd,confirm,6);
				usleep(WAITTIME);
			}	
		}
		else
		{
			printf("not receive E5\n");
			return -5;
		}
		nread=read(fd, buff, 512);
		printf("\nlen:%d\n", nread);
		if(nread>0)
		{
			for(i=0;i<nread;i++)
			printf("%02x ",buff[i]);
			printf("\n");
			printf("Q is :%02x %02x\n",buff[25],buff[26]);
			q0=dectobin(buff[25]);
			for(i=0;i<8;i++)
			printf("Q0.%d=%d\n",i,q0[i]);
			q1=dectobin(buff[26]);
			for(i=0;i<8;i++)
			printf("Q1.%d=%d\n",i,q1[i]);
			free(q0);
			q0=NULL;
			free(q1);
			q1=NULL;
		}
			write(fd,hello,6);
			usleep(WAITTIME);
			nread=read(fd, buff, 512);//接收返回数据
			//读取输出结束
		
		//下面开始读取输入I0.0-I2.7
		write(fd,readi,33);//发送读输入指令
		usleep(WAITTIME);
		nread=read(fd, buff, 512);//接收返回数据
		if(nread>0)
		{
			if(buff[0]==0xE5)
			{
				//printf("receive E5\n");
				write(fd,confirm,6);
				usleep(WAITTIME);
			}	
		}
		else
		{
			printf("not receive E5\n");
			return -5;
		}
		nread=read(fd, buff, 512);
		printf("\nlen:%d\n", nread);
		if(nread>0)
		{
			for(i=0;i<nread;i++)
			printf("%02x ",buff[i]);
			printf("\n");
			printf("I is :%02x %02x %02x\n",buff[25],buff[26],buff[27]);
			i0=dectobin(buff[25]);
			for(i=0;i<8;i++)
			printf("I0.%d=%d\n",i,i0[i]);
			i1=dectobin(buff[26]);
			for(i=0;i<8;i++)
			printf("I1.%d=%d\n",i,i1[i]);
			i2=dectobin(buff[27]);
			for(i=0;i<8;i++)
			printf("I2.%d=%d\n",i,i2[i]);
			free(i0);
			i0=NULL;
			free(i1);
			i1=NULL;
			free(i2);
			i2=NULL;
		}
		write(fd,hello,6);
		usleep(WAITTIME);
		nread=read(fd, buff, 512);
		//读取输入结束

/*
变量名称	    变量地址
3#变频	         Q1.1
3#变频备妥	      I0.3
3#变频泵故障	  I0.0
3#变频零速        I0.2
3#变频启动	      Q0.0
3#变频吸合	      I1.2
3#变频运行	      I0.1
3#阀门关到位	   I1.5
3#阀门开到位	   I1.4
4#变频            Q1.2
4#变频吸合	      I1.3
4#阀门关到位	  I1.7
4#阀门开到位	  I1.6
4#关阀	         Q0.4
4#开阀	         Q0.3
5#变频备妥	      I0.3
5#变频泵故障	   I0.0
5#变频复位	      I1.4
5#变频零速	      I0.2
5#变频启动	      Q0.0
5#变频远程状态	   Q0.1
5#变频运行	      I0.1
5#阀门关到位	  I1.7
5#阀门开到位	  I1.6
*/
		
		
		vd312=readvd(fd,readvd312);//热交换器出夜温度
		//printf("vd312=%x \n",vd312);
		vd300=readvd(fd,readvd300);//储夜槽1液位
		vd304=readvd(fd,readvd304);//储夜槽2液位
		vd308=readvd(fd,readvd308);//储夜槽3液位
		vd18 =readvd(fd,readvd18);//冷却泵1频率
		vd22=readvd(fd,readvd22);//冷却泵2频率
		vd534=readvd(fd,readvd534);//3#泵电流
		vd4550=readvd(fd,readvd4550);//3#泵运行时间
		//printf("vd4550=%x \n",vd4550);
		vd540=readvd(fd,readvd540);//4#泵电流
		vd4580=readvd(fd,readvd4550);//4#泵运行时间

		vw172=readvw(fd,readvw172);//1#储夜泵频率
		//printf("vw172=%x \n",vw172);
		vw178=readvw(fd,readvw178);//2#储夜泵频率
		vw184=readvw(fd,readvw184);//3#储夜泵频率
		vw190=readvw(fd,readvw190);//1#高位泵泵频率
		vw196=readvw(fd,readvw196);//2#高位泵泵频率
		vw202=readvw(fd,readvw202);//3#高位泵泵频率
		vw208=readvw(fd,readvw208);//4#高位泵泵频率
		vw192=readvw(fd,readvw192);//1#泵工作电流
		vw198=readvw(fd,readvw198);//2#泵工作电流
		vw204=readvw(fd,readvw204);//3#泵工作电流
		vw210=readvw(fd,readvw210);//4#泵工作电流
		//testvd312
		/*
		write(fd,readvd312,33);//发送读输出指令
		usleep(WAITTIME);
		nread=read(fd, buff, 512);//接收返回数据
		if(nread>0)
		{
			if(buff[0]==0xE5)
			{
				printf("receive E5\n");
				write(fd,confirm,6);
				usleep(WAITTIME);
			}	
		}
		else
		{
			printf("not receive E5\n");
			return -5;
		}
		nread=read(fd, buff, 512);
		printf("\nlen:%d\n", nread);
		if(nread>0)
		{
			for(i=0;i<nread;i++)
			printf("%02x ",buff[i]);
			printf("\n");
			printf("vd312=%x ",(buff[25]<<24)+(buff[26]<<16)+(buff[27]<<8)+buff[28]);
			
		}
			write(fd,hello,6);
			usleep(WAITTIME);
			nread=read(fd, buff, 512);
		*/

		//usleep(900000);
	}
	close(fd);
	return 0;
}





		
